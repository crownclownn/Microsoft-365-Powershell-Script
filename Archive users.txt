# Connect to Exchange Online
$UserCredential = Get-Credential
Connect-ExchangeOnline -UserPrincipalName $UserCredential.UserName -ShowProgress $true

# Get users with Online Archive
$UsersWithArchive = Get-Mailbox -ResultSize Unlimited | Where-Object { $_.ArchiveStatus -eq 'Active' }
$ArchiveUserList = @()

foreach ($User in $UsersWithArchive) {
    $ArchiveUserList += [PSCustomObject]@{
        DisplayName = $User.DisplayName
        PrimarySmtpAddress = $User.PrimarySmtpAddress
        ArchiveStatus = $User.ArchiveStatus
    }
}

# Export the data to a CSV file
$ArchiveUserList | Export-Csv -Path "C:\UsersWithOnlineArchive.csv" -NoTypeInformation

# Disconnect from Exchange Online
Disconnect-ExchangeOnline -Confirm:$false